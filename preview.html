<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CF-Workers-SUB è®¢é˜…ç®¡ç†</title>
<style>
:root{--primary:#6366f1;--primary-dark:#4f46e5;--text:#1f2937;--text-light:#6b7280;--bg:#f9fafb;--card:#ffffff;--border:#e5e7eb}
[data-theme="dark"]{--text:#f3f4f6;--text-light:#9ca3af;--bg:#111827;--card:#1f2937;--border:#374151}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:20px;line-height:1.6}
.container{max-width:1100px;margin:0 auto;background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.1);overflow:hidden}
header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:white;padding:2rem;text-align:center;position:relative}
header h1{margin:0;font-size:1.8rem}header p{margin:.5rem 0 0;opacity:.9}
.theme-toggle{position:absolute;top:1rem;right:1rem;background:rgba(255,255,255,.2);border:none;color:white;padding:.5rem;border-radius:8px;cursor:pointer;font-size:1.2rem;transition:.2s}
.theme-toggle:hover{background:rgba(255,255,255,.3)}
.section{padding:1.8rem;border-bottom:1px solid var(--border)}
.section:last-child{border-bottom:none}
h2{font-size:1.4rem;margin:0 0 1rem;color:var(--text);display:flex;align-items:center;gap:.5rem}
h2::before{content:"";width:6px;height:1.6em;background:var(--primary);border-radius:3px}
.sub-container{display:grid;grid-template-columns:1fr 1fr;gap:2rem;margin-top:.8rem;align-items:center}
.sub-buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:.4rem;max-height:280px}
.sub-buttons .section-title{grid-column:1/-1;text-align:center;font-weight:600;color:var(--primary);margin:.3rem 0;font-size:.9rem}
.sub-buttons.compact .sub-btn{padding:.4rem .3rem;font-size:.8rem;line-height:1.1}
.sub-btn{padding:.5rem .4rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;text-align:center;cursor:pointer;font-size:.85rem;transition:.2s;line-height:1.2}
.sub-btn:hover{background:var(--primary);color:white;border-color:var(--primary)}
.qrcode-display{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:1rem;text-align:center;display:flex;flex-direction:column;justify-content:center;align-items:center;width:240px;height:240px;box-sizing:border-box;overflow:hidden;margin:0 auto}
.qrcode-display .placeholder{color:var(--text-light);font-size:1.1rem}
#qr-temp{margin:1rem 0}
.link-info{word-break:break-all;margin:.8rem 0;color:var(--text-light);font-size:.9rem;max-width:90%}
.copy-btn{background:var(--primary);color:white;border:none;padding:.6rem 1.2rem;border-radius:8px;cursor:pointer;margin-top:.5rem}
.save-container{margin-top:1rem;display:flex;align-items:center;gap:1rem}
.save-btn{background:var(--primary);color:white;border:none;padding:.7rem 1.5rem;border-radius:8px;cursor:pointer}
.toggle-btn{background:none;border:none;color:var(--primary);font-size:1rem;cursor:pointer;margin-top:.5rem}
.toggle-btn:hover{text-decoration:underline}
.hidden{display:none}
.var-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1.5rem}
.var-item label{display:block;margin-bottom:.4rem;font-weight:600}
.var-item small{display:block;color:var(--text-light);font-size:.85rem;margin-top:.3rem}
.var-item input{width:100%;padding:.7rem;border:1px solid var(--border);border-radius:8px;box-sizing:border-box}
#content{width:100%;height:300px;padding:1rem;border:1px solid var(--border);border-radius:10px;font-family:'JetBrains Mono',monospace;font-size:14.5px;background:var(--bg);color:var(--text);resize:vertical;box-sizing:border-box}
#content:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(99,102,241,.2)}
footer{text-align:center;padding:1.5rem;font-size:.9rem;color:var(--text-light);background:var(--bg)}
@media (max-width:768px){
.sub-container{grid-template-columns:1fr;gap:1.5rem;align-items:center;margin-top:1rem}
.sub-buttons{grid-template-columns:1fr;gap:1rem;max-height:none}
.sub-btn{font-size:1.1rem;padding:1.2rem 1rem;line-height:1.3;border-radius:10px;min-height:56px}
.sub-buttons .section-title{font-size:1rem;margin:.5rem 0}
.qrcode-display{width:280px;height:280px;margin:1.5rem auto;padding:1.2rem}
.qrcode-display .placeholder{font-size:1.2rem}
.var-grid{grid-template-columns:1fr;gap:1.2rem}
.var-item label{font-size:1rem;margin-bottom:.6rem}
.var-item input{padding:.8rem;border-radius:10px;font-size:1rem}
#content{height:250px;padding:1rem;border-radius:10px;font-size:16px}
.toggle-btn{font-size:1.1rem;padding:.8rem 0}
.save-btn{font-size:1rem;padding:1rem 1.5rem;border-radius:10px}
.save-container{gap:.8rem;flex-wrap:wrap}
.theme-toggle{font-size:1.2rem;padding:.6rem;border-radius:8px}
h1{font-size:1.6rem;line-height:1.3}
h2{font-size:1.3rem;margin:0 0 1.2rem}
.section{padding:1.5rem}
.container{padding:0 1rem}
.link-info{font-size:.8rem}
.copy-btn{font-size:.8rem;padding:.4rem .8rem}
footer{font-size:.85rem;padding:1.2rem}
footer p{margin:.5rem 0}
}
</style>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/jetbrains-mono@4.5.12/index.min.css">
</head>
<body>
<div class="container">
<header>
  <button class="theme-toggle" id="themeToggle" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
  <h1>CF-Workers-SUB è®¢é˜…ç®¡ç†</h1><p>è‡ªå»ºèŠ‚ç‚¹ + æœºåœºèšåˆè®¢é˜…è½¬æ¢</p>
</header>

<div class="section">
<h2>è®¢é˜…è¿æ¥</h2>
<div class="sub-container">
<div class="sub-buttons" id="subscription-buttons"></div>
<div class="qrcode-display" id="qrcode-display"><p class="placeholder">ç‚¹å‡»å·¦ä¾§æŒ‰é’®ç”ŸæˆäºŒç»´ç </p></div>
</div>
</div>

<div class="section">
<h2>å˜é‡é…ç½®</h2>
<button class="toggle-btn" id="varToggle">å±•å¼€é…ç½® â†“</button>
<div id="varSection" class="hidden">
<div class="var-grid">
<div class="var-item" style="grid-column:1/-1">
<label for="subConverter">SUB-Converterï¼ˆè®¢é˜…è½¬æ¢æœåŠ¡åœ°å€ï¼‰</label>
<input id="subConverter" value="SUBAPI.cmliussss.net">
<small>è®¢é˜…è½¬æ¢æœåŠ¡çš„åœ°å€ï¼Œç”¨äºè½¬æ¢è®¢é˜…æ ¼å¼ï¼Œå¯ç•™ç©ºä½¿ç”¨é»˜è®¤å€¼</small>
<small style="display:block;margin-top:.2rem;color:var(--text-light);">æ”¯æŒè‡ªå»ºpsub å¯è‡ªè¡Œæ­å»º https://github.com/tgszy/Psub</small>
</div>
<div class="var-item" style="grid-column:1/-1">
<label for="subConfig">SUB-Configï¼ˆè®¢é˜…é…ç½®æ–‡ä»¶ï¼‰</label>
<input id="subConfig" value="https://raw.githubusercontent.com/cmliu/ACL4SSR/main/Clash/config/ACL4SSR_Online_MultiCountry.ini">
<small>è®¢é˜…é…ç½®æ–‡ä»¶URLï¼Œç”¨äºClashç­‰å®¢æˆ·ç«¯çš„é…ç½®è§„åˆ™</small>
<small style="display:block;margin-top:.2rem;color:var(--text-light);">è§„åˆ™åˆ—è¡¨ https://github.com/tgszy/ACL4SSR/tree/main/Clash/config</small>
</div>
<div class="var-item">
<label for="TOKEN">TOKENï¼ˆä¸»äººä»¤ç‰Œï¼‰</label>
<input id="TOKEN" value="auto">
<small>ç”¨äºæµè§ˆå™¨è®¿é—®æœ¬é…ç½®é¡µçš„è·¯å¾„ä»¤ç‰Œï¼Œä¾‹å¦‚è®¾ç½®ä¸º abc åˆ™è®¿é—® https://your.domain/abc</small>
</div>
<div class="var-item">
<label for="GUESTTOKEN">GUESTTOKENï¼ˆè®¿å®¢ä»¤ç‰Œï¼‰</label>
<input id="GUESTTOKEN" value="6ac0974f22bda6966c4538638523ebd5">
<small>è®¿å®¢é€šè¿‡ /sub?token=xxx è®¿é—®è®¢é˜…é“¾æ¥çš„ä»¤ç‰Œï¼Œå¯éšä¾¿è®¾ç½®æˆ–ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ</small>
<small style="display:block;margin-top:.2rem;color:#ef4444;">è®¿å®¢ä»¤ç‰Œä¿®æ”¹åï¼Œæ›´æ–°å˜é‡åè®¿å®¢è®¢é˜…æœªåˆ·æ–°ï¼Œå®é™…å·²ç”Ÿæ•ˆï¼Œéœ€è¦åˆ·æ–°é¡µé¢</small>
</div>
<div class="var-item">
<label for="TGTOKEN">TGTOKENï¼ˆTelegram Bot Tokenï¼‰</label>
<input id="TGTOKEN" value="">
<small>ç”¨äºæ¥æ”¶è®¿é—®é€šçŸ¥çš„ Bot Tokenï¼Œå¯ç•™ç©ºä¸å¯ç”¨é€šçŸ¥</small>
</div>
<div class="var-item">
<label for="TGID">TGIDï¼ˆTelegram Chat IDï¼‰</label>
<input id="TGID" value="">
<small>æ¥æ”¶é€šçŸ¥çš„èŠå¤©IDï¼Œå¯é€šè¿‡ @userinfobot è·å–</small>
</div>
</div>
<div class="save-container" style="margin-top:1.5rem">
<button class="save-btn" onclick="updateVars(this)">æ›´æ–°å˜é‡</button>
<span class="save-status" id="varStatus"></span>
</div>
</div>
</div>

<div class="section">
<h2>èŠ‚ç‚¹é“¾æ¥ç¼–è¾‘</h2>
<textarea id="content" placeholder="æ¯è¡Œä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…æœºåœºè®¢é˜…é“¾æ¥
èŠ‚ç‚¹ç¤ºä¾‹ï¼š
vless://
vmess://
trojan://
tuic://
æœºåœºè®¢é˜…é“¾æ¥

#å·å¯ä½œä¸º èŠ‚ç‚¹å¤‡æ³¨ä¹Ÿå¯ä¿®æ”¹èŠ‚ç‚¹é»˜è®¤åç§°
VmessèŠ‚ç‚¹ å¯ä½¿ç”¨Base64è§£ç åï¼Œä¿®æ”¹èŠ‚ç‚¹åç§°åå†é‡æ–°ç¼–ç åå¯¼å…¥ä½¿ç”¨"></textarea>
<div class="save-container">
<button class="save-btn" onclick="saveContent(this)">ä¿å­˜é…ç½®</button>
<span class="save-status" id="saveStatus"></span>
</div>
</div>

<footer>
<p>Telegram: <a href="https://t.me/CMLiussss">@CMLiussss</a> | GitHub: <a href="https://github.com/cmliu/CF-Workers-SUB">cmliu/CF-Workers-SUB</a></p>
</footer>
</div>

<script>
// ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
const themeToggle = document.getElementById('themeToggle');
const savedTheme = localStorage.getItem('theme') || 'light';
if (savedTheme === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
    themeToggle.textContent = 'â˜€ï¸';
}

themeToggle.onclick = () => {
    const html = document.documentElement;
    const isDark = html.getAttribute('data-theme') === 'dark';
    if (isDark) {
        html.removeAttribute('data-theme');
        themeToggle.textContent = 'ğŸŒ™';
        localStorage.setItem('theme', 'light');
    } else {
        html.setAttribute('data-theme', 'dark');
        themeToggle.textContent = 'â˜€ï¸';
        localStorage.setItem('theme', 'dark');
    }
};

function createSubscriptionButtons() {
	const container = document.getElementById('subscription-buttons');
	
	// æ¸…é™¤ç°æœ‰æŒ‰é’®
	container.innerHTML = '';
	
	// æ·»åŠ ä¸»äººè®¢é˜…æ ‡é¢˜
	const ownerTitle = document.createElement('div');
	ownerTitle.className = 'section-title';
	ownerTitle.textContent = 'ä¸»äººè®¢é˜…';
	container.appendChild(ownerTitle);
	
	// ä¸»äººè®¢é˜…é“¾æ¥ï¼ˆå›ºå®šä¸å˜ï¼‰
	const ownerLinks = [
		["è‡ªé€‚åº”è®¢é˜…", location.origin + "/auto"],
		["Base64 è®¢é˜…", location.origin + "/auto?b64"],
		["Clash è®¢é˜…", location.origin + "/auto?clash"],
		["Sing-box è®¢é˜…", location.origin + "/auto?sb"],
		["Surge è®¢é˜…", location.origin + "/auto?surge"],
		["Loon è®¢é˜…", location.origin + "/auto?loon"]
	];
	
	// æ·»åŠ ä¸»äººè®¢é˜…æŒ‰é’®ï¼ˆæ‰€æœ‰æŒ‰é’®ï¼‰
	ownerLinks.forEach(([name, link]) => {
		const btn = document.createElement('button');
		btn.className = 'sub-btn';
		btn.textContent = name;
		btn.onclick = () => generateQR(link, 'qrcode-display', name);
		container.appendChild(btn);
	});
	
	// æ·»åŠ è®¿å®¢è®¢é˜…æ ‡é¢˜
	const guestTitle = document.createElement('div');
	guestTitle.className = 'section-title';
	guestTitle.textContent = 'è®¿å®¢è®¢é˜…';
	container.appendChild(guestTitle);
	
	// è·å–å½“å‰GUESTTOKENå€¼ï¼ˆä¼˜å…ˆä½¿ç”¨KVä¸­çš„å€¼ï¼‰
	const guestTokenInput = document.getElementById('GUESTTOKEN');
	const guestToken = (guestTokenInput && guestTokenInput.value) ? guestTokenInput.value : '6ac0974f22bda6966c4538638523ebd5';
	const guestBase = location.origin + "/sub?token=" + guestToken;
	

	
	// é‡æ–°æ„å»ºè®¿å®¢è®¢é˜…é“¾æ¥
	const guestLinks = [
		["è®¿å®¢è‡ªé€‚åº”", guestBase],
		["è®¿å®¢ Base64", guestBase + "&b64"],
		["è®¿å®¢ Clash", guestBase + "&clash"],
		["è®¿å®¢ Sing-box", guestBase + "&sb"],
		["è®¿å®¢ Surge", guestBase + "&surge"],
		["è®¿å®¢ Loon", guestBase + "&loon"]
	];
	
	// æ·»åŠ è®¿å®¢è®¢é˜…æŒ‰é’®ï¼ˆæ‰€æœ‰æŒ‰é’®ï¼‰
	guestLinks.forEach(([name, link]) => {
		const btn = document.createElement('button');
		btn.className = 'sub-btn';
		btn.textContent = name;
		btn.onclick = () => generateQR(link, 'qrcode-display', name);
		container.appendChild(btn);
	});
	
	// æ·»åŠ è®¿å®¢è®¢é˜…æç¤ºæ–‡æœ¬
	const guestWarning = document.createElement('div');
	guestWarning.style.cssText = 'grid-column:1/-1;text-align:center;color:var(--text-light);font-size:.8rem;margin-top:.3rem;padding:.3rem .5rem;background:var(--bg);border:1px dashed var(--border);border-radius:6px;';
	guestWarning.textContent = 'æ³¨æ„ï¼šè®¿å®¢è®¢é˜…ä»…æä¾›è®¢é˜…åŠŸèƒ½ï¼Œè®¿é—®ä¸äº†é¢æ¿';
	container.appendChild(guestWarning);
}

function generateQR(link, displayId, name) {
	const display = document.getElementById(displayId);
	display.innerHTML = `
		<h3 style="margin:0 0 .3rem;font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%">${name}</h3>
		<div id="qr-temp" style="display:flex;justify-content:center;align-items:center;"></div>
		<p class="link-info" style="word-break:break-all;margin:.3rem 0;color:var(--text-light);font-size:.7rem;max-width:100%;line-height:1.2">${link}</p>
		<button class="copy-btn" onclick="navigator.clipboard.writeText('${link}').then(()=>alert('å·²å¤åˆ¶ï¼')).catch(()=>prompt('å¤åˆ¶å¤±è´¥ï¼Œæ‰‹åŠ¨å¤åˆ¶ï¼š','${link}'))" style="background:var(--primary);color:white;border:none;padding:.3rem .6rem;border-radius:6px;cursor:pointer;font-size:.7rem;margin-top:.2rem">å¤åˆ¶é“¾æ¥</button>
	`;
	new QRCode(document.getElementById("qr-temp"), {
		text: link,
		width: 120,
		height: 120,
		colorDark: "#000000",
		colorLight: "#ffffff",
		correctLevel: QRCode.CorrectLevel.H
	});
}

// é¡µé¢åˆå§‹åŒ–æ—¶è·å–KVä¸­çš„æœ€æ–°å˜é‡å€¼
initializeVars().then(() => {
    createSubscriptionButtons();
});

document.getElementById('varToggle').onclick = () => {
	const sec = document.getElementById('varSection');
	const btn = document.getElementById('varToggle');
	sec.classList.toggle('hidden');
	btn.textContent = sec.classList.contains('hidden') ? 'å±•å¼€é…ç½® â†“' : 'æ”¶èµ·é…ç½® â†‘';
};

function saveContent(btn) {
	btn.disabled = true; btn.textContent = 'ä¿å­˜ä¸­...';
	document.getElementById('saveStatus').textContent = 'ä¿å­˜æˆåŠŸ ' + new Date().toLocaleString();
	setTimeout(() => {
		btn.disabled = false; 
		btn.textContent = 'ä¿å­˜é…ç½®';
	}, 1000);
}

// é¡µé¢åˆå§‹åŒ–æ—¶ä»KVè·å–æœ€æ–°å˜é‡å€¼
async function initializeVars() {
    try {
        const response = await fetch('/getVars');
        if (response.ok) {
            const vars = await response.json();
            
            // æ›´æ–°è¾“å…¥æ¡†å€¼
            const inputs = ['subConverter', 'subConfig', 'TOKEN', 'GUESTTOKEN', 'TGTOKEN', 'TGID'];
            inputs.forEach(id => {
                const elem = document.getElementById(id);
                if (elem && vars[id]) {
                    elem.value = vars[id];
                }
            });
        }
    } catch (error) {
        console.log('è·å–å˜é‡å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);
    }
}

// æ›´æ–°å˜é‡åˆ°KVå­˜å‚¨
async function updateVars(btn) {
    btn.disabled = true;
    btn.textContent = 'æ›´æ–°ä¸­...';
    const status = document.getElementById('varStatus');
    
    try {
        const data = {};
        const inputs = ['subConverter', 'subConfig', 'TOKEN', 'GUESTTOKEN', 'TGTOKEN', 'TGID'];
        
        inputs.forEach(id => {
            const elem = document.getElementById(id);
            if (elem) {
                data[id] = elem.value;
            }
        });
        
        // å¦‚æœGUESTTOKENä¸ºç©ºï¼Œå¼ºåˆ¶è®¾ç½®ä¸ºé»˜è®¤å€¼
        if (!data.GUESTTOKEN || data.GUESTTOKEN.trim() === '') {
            data.GUESTTOKEN = '6ac0974f22bda6966c4538638523ebd5';
            document.getElementById('GUESTTOKEN').value = '6ac0974f22bda6966c4538638523ebd5';
        }
        
        const response = await fetch('/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            status.textContent = 'âœ“ æ›´æ–°æˆåŠŸ';
            status.style.color = '#16a34a';
            
            // ç«‹å³ä»KVè·å–æœ€æ–°å€¼å¹¶æ›´æ–°UI
            await initializeVars();
            
            // æ¸…é™¤äºŒç»´ç æ˜¾ç¤ºï¼Œå› ä¸ºè®¿å®¢è®¢é˜…é“¾æ¥å¯èƒ½å·²ç»æ›´æ–°
            const qrcodeDisplay = document.getElementById('qrcode-display');
            if (qrcodeDisplay) {
                qrcodeDisplay.innerHTML = '<p style="color:var(--text-light);text-align:center;margin-top:2rem;">äºŒç»´ç å·²æ¸…é™¤ï¼Œè¯·é‡æ–°ç‚¹å‡»è®¿å®¢è®¢é˜…æŒ‰é’®ç”Ÿæˆæ–°äºŒç»´ç </p>';
            }
            
            // é‡æ–°ç”Ÿæˆè®¢é˜…æŒ‰é’®ï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°çš„GUESTTOKEN
            createSubscriptionButtons();
            
            // æ¸…é™¤ä¸´æ—¶çŠ¶æ€
            setTimeout(() => {
                status.textContent = '';
            }, 3000);
        } else {
            status.textContent = 'âœ— æ›´æ–°å¤±è´¥';
            status.style.color = '#dc2626';
        }
    } catch (error) {
        console.error('Error:', error);
        status.textContent = 'âœ— ç½‘ç»œé”™è¯¯';
        status.style.color = '#dc2626';
    } finally {
        btn.disabled = false;
        btn.textContent = 'æ›´æ–°å˜é‡';
    }
}
</script>
</body>
</html>